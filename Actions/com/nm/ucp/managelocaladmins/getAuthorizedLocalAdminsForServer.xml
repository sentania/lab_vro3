<?xml version='1.0' encoding='UTF-8'?>
<dunes-script-module name="getAuthorizedLocalAdminsForServer" result-type="Array/string" api-version="6.0.0" id="d710e068-f3a3-4d2c-a99b-546568820cfc" version="0.0.0" allowed-operations="vfe" category-name="com.nm.ucp.managelocaladmins">
  <param n="serverName" t="string"><![CDATA[The Server name to query]]></param>
  <script encoded="false"><![CDATA[// Returns a collection of REST:RESTHost object types from the inventory service plugin
var restHost = RESTHostManager.getHost('70e161fb-50fe-4860-a709-7904ba88f2ad')
var restOperation = restHost.getOperation('70e161fb-50fe-4860-a709-7904ba88f2ad:f73443c9-66e2-4517-8df1-b6c172ba1d6e')


var baseURL = 'unifiedcompute/servers/';  //the base URL for all UCP records in etcd
var serverURL = baseURL + serverName + '/';
var admins = serverURL + 'admins?recursive=true'
var inParamtersValues = [admins];
var content ="";
var defaultContentType = "application/json";
var request = restOperation.createRequest(inParamtersValues, content);

var response = request.execute();
//prepare output parameters

request.contentType = defaultContentType;
System.log("Request: " + request);
System.log("Request URL: " + request.fullUrl);
var response = request.execute();
System.log("Response: " + response);
var statusCode = response.statusCode;
var statusCodeAttribute = statusCode;
System.log("Status code: " + statusCode);
var contentLength = response.contentLength;
var headers = response.getAllHeaders();
var contentAsString = response.contentAsString;
System.log("Content as string: " + contentAsString);
System.log("****Headers****");
for each (var header in headers){
	System.log(header.toString());
}


System.log(contentAsString);
var adminArray = [];
if (contentAsString.search("errorCode") == -1)
{

	var obj = JSON.parse(contentAsString);

	var adminsDir = obj.node.nodes;
	
	for(var i = 0; i < adminsDir.length; i++){
		var adminDir = adminsDir[i];
		System.log("Admin Dir Key: " + adminDir.key);
		for (j in adminDir.nodes)
		{
			
			var tmpString = adminDir.nodes[j].key
	
			if (tmpString.search('name') != -1)
			{
				var adminName = adminDir.nodes[j].value;
			}
			if (tmpString.search('state') != -1)
			{
				var adminState = adminDir.nodes[j].value;
			}
		
		}
		if (adminState == 'grant')
		{
			System.log("Admin Name (grant): " + adminName);
			adminArray.push(adminName);
		}	
	
	
		
		}
}
else
{ 
	adminArray.push('No Authorized groups on this server');
}
return adminArray;
]]></script>
</dunes-script-module>