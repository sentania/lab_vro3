<?xml version='1.0' encoding='UTF-8'?>
<dunes-script-module name="Select_Machine_Basedon_OS_and_ENV" result-type="Array/string" api-version="6.0.0" id="93d300aa-f514-437f-9e24-7f342471ce73" version="0.0.0" allowed-operations="vfe" category-name="com.nm.ucp">
  <param n="propertyValue" t="string"/>
  <param n="propertyValue1" t="string"/>
  <param n="propertyValue2" t="string"/>
  <script encoded="false"><![CDATA[var propertyName = "nm.ucp.BusinessGroupName";
var propertyName1 = "ucp.tag.environment"
var propertyValue
var propertyValue1  
var propertyValue2 
var host = Server.findAllForType("vCAC:VCACHost")[1];
var servers = new Array();
// Define the filter that is used for search for the entities
var filter = "VirtualMachineProperties/any(p: p/PropertyName eq '" + propertyName + "' and p/PropertyValue eq '" +propertyValue+ "')";
System.log(filter)
var machines = vCACEntityManager.readModelEntitiesBySystemQuery(
    host.id,                        //vCAC IaaS host id
    "ManagementModelEntities.svc",  //model
    "VirtualMachines",              //Entity Type in IaaS API
    filter                          //filter
    )



if(propertyValue1 == "All"){
	machines.forEach(function(machine) {
	tCheck = machine.getProperty("GuestOS")
	if((tCheck.toLowerCase()).match(propertyValue2)){
			var servername = (machine.getProperty("VirtualMachineName"));
			servers.push(servername);
		}
	}
	)
 }else{
		machines.forEach(function(machine) {
		var servername = (machine.getProperty("VirtualMachineName"));
		tCheck = machine.getProperty("GuestOS")
		vcacVm = Server.findAllForType("vCAC:VirtualMachine", "VirtualMachineName eq '" +servername+"'");
		var vCACMachineEntity = vcacVm[0].getEntity();
		var vCACMachineEntityProperties = vCACMachineEntity.getLink(host,"VirtualMachineProperties");
		var vCACVmProperties = new Properties();
		tCheck = machine.getProperty("GuestOS")
	 	for each (var vCACMachineEntityProperty in vCACMachineEntityProperties) {
			if(vCACMachineEntityProperty.getProperty("PropertyName") == propertyName1 &&  vCACMachineEntityProperty.getProperty("PropertyValue") == propertyValue1 && (tCheck.toLowerCase()).match(propertyValue2)){
				servers.push(servername);
			 }
		  }
	   }
	)
}	
servers.sort();
System.log(servers)
return servers





]]></script>
</dunes-script-module>