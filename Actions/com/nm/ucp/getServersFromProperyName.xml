<?xml version='1.0' encoding='UTF-8'?>
<dunes-script-module name="getServersFromProperyName" result-type="Array/string" api-version="6.0.0" id="0bef5225-b0a2-4937-aa12-b0ef8830c06c" version="0.0.0" allowed-operations="vfe" category-name="com.nm.ucp">
  <param n="propertyName" t="string"><![CDATA[Property Name to filter on]]></param>
  <param n="propertyValue" t="string"><![CDATA[Property Value you are looking for]]></param>
  <param n="servers" t="Array/string"><![CDATA[Returned Servers]]></param>
  <script encoded="false"><![CDATA[//var propertyName = "ucp.tag.environment";
//var propertyValue = "Development";
var servers = new Array();

// Define the filter that is used for search for the entities
var filter = "VirtualMachineProperties/any(p: p/PropertyName eq '" + propertyName + "' and p/PropertyValue eq '" + propertyValue + "')";
 
var machines = vCACEntityManager.readModelEntitiesBySystemQuery(
    host.id,                        //vCAC IaaS host id
    "ManagementModelEntities.svc",  //model
    "VirtualMachines",              //Entity Type in IaaS API
    filter                          //filter
    )
 
machines.forEach(function(machine) {
    System.log(machine.getProperty("VirtualMachineName"));
	servers.push(machine.getProperty("VirtualMachineName"));
	
});

servers.sort();
return servers;]]></script>
</dunes-script-module>