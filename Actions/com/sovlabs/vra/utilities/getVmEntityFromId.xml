<?xml version='1.0' encoding='UTF-8'?>
<dunes-script-module name="getVmEntityFromId" result-type="vCAC:Entity" api-version="6.0.0" id="71ad22d5-f373-462d-a11d-00daf260b1e1" version="0.0.1" allowed-operations="evf" category-name="com.sovlabs.vra.utilities">
  <param n="host" t="vCAC:VCACHost"/>
  <param n="virtualMachineId" t="string"/>
  <script encoded="false"><![CDATA[var properties = new Properties();
properties.put("VirtualMachineID", virtualMachineId);

var vmEntity = null;

if (host != null) {
	vmEntity = vCACEntityManager.readModelEntity(host.id, "ManagementModelEntities.svc", "VirtualMachines", properties, null);
	if (vmEntity == null) {
		throw "Unable to find vRA entity from ID '" + virtualMachineId + " in host: " + host.name;
	}
	return vmEntity;
}

var attemptedHosts = new Array();

var hosts = Server.findAllForType("vCAC:VCACHost");
System.log("hosts: " + hosts);
for each (var host in hosts) {
	try {
		var entity = vCACEntityManager.readModelEntity(host.id, "ManagementModelEntities.svc", "VirtualMachines", properties, null);
		if (entity != null) return entity;
		attemptedHosts.push(host.name);
	} catch (e) {
		System.log("Error reading model entity on host: " + host.name);
		attemptedHosts.push(host.name);
	}
}

throw "Unable to find vRA entity from ID '" + virtualMachineId + " in host(s): " + attemptedHosts.join(", ");


]]></script>
</dunes-script-module>