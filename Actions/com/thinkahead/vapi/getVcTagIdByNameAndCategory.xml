<?xml version='1.0' encoding='UTF-8'?>
<dunes-script-module name="getVcTagIdByNameAndCategory" result-type="string" api-version="6.0.0" id="6d5e963d-0724-499d-bf6b-25a30b9310ae" version="1.0.1" allowed-operations="evf" category-name="com.thinkahead.vapi">
  <param n="endpoint" t="VAPI:VAPIEndpoint"><![CDATA[the vAPI endpoint on which to look]]></param>
  <param n="tagName" t="string"><![CDATA[the name of the Tag to look for]]></param>
  <param n="tagCategoryId" t="string"><![CDATA[the ID of the Tag Category to look for]]></param>
  <script encoded="false"><![CDATA[if (endpoint == null) {
  throw "'endpoint' parameter should not be null";
}
//Return null if the Category ID is null
if (!tagCategoryId) return null;

var client = endpoint.client();
var tagging = new com_vmware_cis_tagging_tag(client);
var tagIdList = tagging.list();

//Look through all the tags for the specified name
for each (var tagId in tagIdList) {
	//Retrieve the full tag object for each tag ID
	var tagObject = tagging.get(tagId);
	//tagObject properties:
	//  [{category_id=urn:vmomi:InventoryServiceCategory:e6549f2d-b23b-4608-9ec3-c17516e820ed:GLOBAL, name=test-ted-tag, description=, id=urn:vmomi:InventoryServiceTag:9423c527-83ce-4f43-868d-48c92be7c116:GLOBAL, used_by=[]}]
	//System.debug(tagObject.name);
	if (tagObject.name == tagName && tagObject.category_id.indexOf(tagCategoryId) != -1) {
		System.debug("Tag with name '" + tagName + "' found, ID: " + tagObject.id);
		return tagObject.id;
	}
}

System.debug("Tag with name '" + tagName + "' was not found on vAPI endpoint '" + endpoint.name + "'");
return null;]]></script>
</dunes-script-module>