<?xml version='1.0' encoding='UTF-8'?>
<workflow xmlns="http://vmware.com/vco/workflow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://vmware.com/vco/workflow http://vmware.com/vco/workflow/Workflow-v4.xsd" root-name="item1" object-name="workflow:name=generic" id="3f52627a-6716-472b-a0ec-5cef367fa2fa" version="0.0.9" api-version="6.0.0" allowed-operations="vfe" restartMode="1" resumeFromFailedMode="0">
  <display-name><![CDATA[Update Support Info]]></display-name>
  <description><![CDATA[This workflow will be used in an XaaS form to allow a business group to update either their UTAN, ETCC KB, or Pager Duty Info.]]></description>
  <position y="50.0" x="100.0"/>
  <input>
    <param name="servers" type="Array/string"/>
    <param name="itemToUpdate" type="string"/>
    <param name="changedTo" type="string"/>
    <param name="utanNumber" type="string"/>
    <param name="utanName" type="string"/>
  </input>
  <output>
    <param name="var" type="Array/CompositeType(statusCode:Number,contentLength:Number,headers:Properties,contentAsString:String)"/>
  </output>
  <attrib name="host" type="vCAC:VCACHost" read-only="false">
    <value encoded="n"><![CDATA[dunes://service.dunes.ch/CustomSDKObject?id='b9c69cb3-e162-4919-be78-4fe8347bc925'&dunesName='vCAC:VCACHost']]></value>
  </attrib>
  <attrib name="etcd_keys" type="Array/string" read-only="false">
    <value encoded="n"><![CDATA[__NULL__]]></value>
  </attrib>
  <attrib name="etcd_values" type="Array/string" read-only="false">
    <value encoded="n"><![CDATA[__NULL__]]></value>
  </attrib>
  <workflow-item name="item0" type="end" end-mode="0">
    <position y="45.40909090909091" x="524.5"/>
  </workflow-item>
  <workflow-item name="item1" out-name="item2" type="task">
    <display-name><![CDATA[Scriptable task]]></display-name>
    <script encoded="false"><![CDATA[//Getting sdk connections
var sdkConnections = VcPlugin.allSdkConnections;
for(var i in sdkConnections){
	   var hostvc = sdkConnections[i];
}

//Documenting selections
System.log("Selected Servers = "  + servers);
System.log("Item to update = "  + itemToUpdate);
System.log("Change value to = "  + changedTo);
System.log("UTAN Number = "  + utanNumber);
System.log("UTAN Name = "  + utanName);

//setup etcd
var baseURL = 'unifiedcompute/servers/';
var etcd_keys = [];
var etcd_values = [];

//Variables
var utanNameProp = "ucp.utan_name";
var utanNumberProp = "ucp.utan";
var pagerDutyProp = "ucp.pagerduty";
var etccKbProp = "ucp.etcc_kb";
var cherwellProp = "nm.ucp.cherwellName";
utanName = utanName.slice(2, -2)
var utanNameVc = "utanName";
var utanNumberVc = "utanNumber";

for each (var server in servers){
	System.log("________________________________");
	System.log("Servername = "+server);
	var serverURL = baseURL + server + '/';
	System.log("ServerURL = " + serverURL);
	
	//Getting vcac vm
	var vcacVm = Server.findAllForType("vCAC:VirtualMachine", "VirtualMachineName eq '" +server+"'");
	
	//Convert vcac:virtualmachine to vc:virtualmachine
	var vSphereVms = hostvc.getAllVirtualMachines(null, "xpath:contains(name, '" + vcacVm[0].getEntity().getProperty("VirtualMachineName") + "')");
	var vcVM = vSphereVms[0];
	
	if (itemToUpdate == "utanName"){
		//Updating etcd info
		System.log("Item Selected = utanName");
		etcd_keys.push(serverURL + 'utanName');
		etcd_values.push(encodeURI(utanName));
		
		//Updating vm properties in vRA
		System.getModule("com.nm.ucp").addUpdatePropertyFromVirtualMachineEntity(host, utanNameProp, utanName, false, false, false, false, vcacVm) ;
		
		//Updating vm custom attribute utanName
		System.getModule("com.vmware.library.vc.customattribute").setOrCreateCustomField(vcVM, utanNameVc, utanName);
		
		//Updating etcd info
		etcd_keys.push(serverURL + 'utanNumber');
		etcd_values.push(utanNumber);
		
		//Updating vm properties in vRA
		System.getModule("com.nm.ucp").addUpdatePropertyFromVirtualMachineEntity(host, utanNumberProp, utanNumber, false, false, false, false, vcacVm) ;
		
		//Updating vm custom attribute utanName
		System.getModule("com.vmware.library.vc.customattribute").setOrCreateCustomField(vcVM, utanNumberVc, utanNumber);
	}
	
	if (itemToUpdate == "pagerDuty"){
		System.log("Item Selected = pagerDuty");
		etcd_keys.push(serverURL + 'pagerDuty');
		etcd_values.push(encodeURI(changedTo));
		
		//Updating vm properties in vRA
		System.getModule("com.nm.ucp").addUpdatePropertyFromVirtualMachineEntity(host, pagerDutyProp, changedTo, false, false, false, false, vcacVm) ;
		
	}
	
	if (itemToUpdate == "etcc_kb"){
		System.log("Item Selected = etccKb");	
		etcd_keys.push(serverURL + 'etccKb');
		etcd_values.push(encodeURI(changedTo));
		
		//Updating vm properties in vRA
		System.getModule("com.nm.ucp").addUpdatePropertyFromVirtualMachineEntity(host, etccKbProp, changedTo, false, false, false, false, vcacVm) ;
	}
	
	if (itemToUpdate == "cherwell"){
		System.log("Item Selected = cherwell");	
		etcd_keys.push(serverURL + 'cherwellName');
		etcd_values.push(encodeURI(changedTo));
		
		//Updating vm properties in vRA
		System.getModule("com.nm.ucp").addUpdatePropertyFromVirtualMachineEntity(host, cherwellProp, changedTo, false, false, false, false, vcacVm) ;
	}

}
System.log("etcd_keys = "+etcd_keys)
System.log("etcd_values = "+etcd_values)
]]></script>
    <in-binding>
      <bind name="servers" type="Array/string" export-name="servers"/>
      <bind name="itemToUpdate" type="string" export-name="itemToUpdate"/>
      <bind name="changedTo" type="string" export-name="changedTo"/>
      <bind name="utanNumber" type="string" export-name="utanNumber"/>
      <bind name="host" type="vCAC:VCACHost" export-name="host"/>
      <bind name="utanName" type="string" export-name="utanName"/>
    </in-binding>
    <out-binding>
      <bind name="etcd_keys" type="Array/string" export-name="etcd_keys"/>
      <bind name="etcd_values" type="Array/string" export-name="etcd_values"/>
    </out-binding>
    <position y="55.40909090909091" x="204.5"/>
  </workflow-item>
  <workflow-item name="item2" out-name="item0" type="foreach">
    <display-name><![CDATA[Foreach (etcd - Add Key)]]></display-name>
    <in-binding>
      <bind name="key" type="Array/string" export-name="*etcd_keys">
        <description><![CDATA[etcd key to update]]></description>
      </bind>
      <bind name="value" type="Array/string" export-name="*etcd_values">
        <description><![CDATA[value of the key]]></description>
      </bind>
    </in-binding>
    <out-binding>
      <bind name="statusCode" type="Array/Number" export-name="*var.statusCode"/>
      <bind name="contentLength" type="Array/Number" export-name="*var.contentLength"/>
      <bind name="headers" type="Array/Properties" export-name="*var.headers"/>
      <bind name="contentAsString" type="Array/String" export-name="*var.contentAsString"/>
    </out-binding>
    <reference type="Workflow" id="1fa52ce3-f6c0-43f8-a28f-6790c2e93f13"/>
    <description><![CDATA[Autogenerated workflow.]]></description>
    <position y="55.40909090909091" x="344.5"/>
  </workflow-item>
  <presentation>
    <p-param name="servers">
      <desc><![CDATA[servers]]></desc>
    </p-param>
    <p-param name="itemToUpdate">
      <desc><![CDATA[itemToUpdate]]></desc>
    </p-param>
    <p-param name="changedTo">
      <desc><![CDATA[changedTo]]></desc>
    </p-param>
    <p-param name="utanNumber">
      <desc><![CDATA[utanNumber]]></desc>
    </p-param>
    <p-param name="utanName">
      <desc><![CDATA[utanName]]></desc>
    </p-param>
  </presentation>
</workflow>