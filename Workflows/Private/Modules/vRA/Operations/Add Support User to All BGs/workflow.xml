<?xml version='1.0' encoding='UTF-8'?>
<workflow xmlns="http://vmware.com/vco/workflow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://vmware.com/vco/workflow http://vmware.com/vco/workflow/Workflow-v4.xsd" root-name="item2" object-name="workflow:name=generic" id="055ca894-6ed7-4af0-8939-dd9742b1fcac" version="0.0.2" api-version="6.0.0" allowed-operations="evf" restartMode="1" resumeFromFailedMode="0">
  <display-name><![CDATA[Add Support User to All BGs]]></display-name>
  <position y="50.0" x="100.0"/>
  <attrib name="cafeHost" type="vCACCAFE:VCACHost" read-only="false">
    <value encoded="n"><![CDATA[dunes://service.dunes.ch/CustomSDKObject?id='bd23869b-b58a-43ca-b0b2-b08857c76199'&dunesName='vCACCAFE:VCACHost']]></value>
  </attrib>
  <attrib name="token" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <workflow-item name="item0" type="end" end-mode="0">
    <position y="45.40909090909091" x="524.5"/>
  </workflow-item>
  <workflow-item name="item1" out-name="item0" type="task">
    <display-name><![CDATA[Scriptable task]]></display-name>
    <script encoded="false"><![CDATA[var getHosts = Server.findAllForType("REST:RESTHost")
for(var i =0; i < getHosts.length ; i++){
	if(getHosts[i].name == "vRA - myucp"){
		var R = getHosts[i]
			//System.log("name - " + R)
		}
}

var group = "[{" + '"domain" : "nm.nmfco.com",' + '"name" : "WG-WST-ADMINISC-PROD"' + "}]"
System.log(group)
//var businessGroup = "UCP Admin"

var subTenants =  vCACCAFEEntitiesFinder.getSubtenants(cafeHost);
for each (var subTenant in subTenants){
	//if (subTenant.name == businessGroup){  //Remove Comment to run on Specific BG
		System.log("BG = "+subTenant.name)
		var uri = "/identity/api/tenants/vsphere.local/subtenants/"+subTenant.id+"/roles/CSP_SUPPORT/principals/"
		System.log("URI = "+uri);
		var request = R.createRequest("POST",uri,group);
		request.setHeader("Accept","application/json");
		request.setHeader("Content-Type","application/json");
		request.contentType = "application/json"
		request.setHeader("Authorization", "Bearer " + token);
	
		var response = request.execute();
		System.log("MY EXECUTION STATUS CODE  - " + response.statusCode)
		
	//} Remove Comment to run on Specific BG
}

]]></script>
    <in-binding>
      <bind name="cafeHost" type="vCACCAFE:VCACHost" export-name="cafeHost"/>
      <bind name="token" type="string" export-name="token"/>
    </in-binding>
    <out-binding/>
    <position y="55.40909090909091" x="344.5"/>
  </workflow-item>
  <workflow-item name="item2" out-name="item1" type="link" linked-workflow-id="519a8f7c-a55b-4878-8e61-0a69d54e94df">
    <display-name><![CDATA[Request-vRAToken]]></display-name>
    <in-binding/>
    <out-binding>
      <bind name="statusCode" type="Number" explicitly-not-bound="true">
        <description><![CDATA[Response status code]]></description>
      </bind>
      <bind name="contentLength" type="Number" explicitly-not-bound="true">
        <description><![CDATA[Response content length]]></description>
      </bind>
      <bind name="headers" type="Properties" explicitly-not-bound="true">
        <description><![CDATA[Response headers]]></description>
      </bind>
      <bind name="token" type="string" export-name="token"/>
    </out-binding>
    <position y="55.40909090909091" x="204.5"/>
  </workflow-item>
  <presentation/>
</workflow>