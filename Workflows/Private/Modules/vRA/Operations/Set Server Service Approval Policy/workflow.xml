<?xml version='1.0' encoding='UTF-8'?>
<workflow xmlns="http://vmware.com/vco/workflow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://vmware.com/vco/workflow http://vmware.com/vco/workflow/Workflow-v4.xsd" root-name="item1" object-name="workflow:name=generic" id="64b09427-c1e8-4b37-aaec-14411ccdd994" version="0.0.3" api-version="6.0.0" allowed-operations="evf" restartMode="1" resumeFromFailedMode="0">
  <display-name><![CDATA[Set Server Service Approval Policy]]></display-name>
  <position y="50.0" x="100.0"/>
  <attrib name="cafeHost" type="vCACCAFE:VCACHost" read-only="false">
    <value encoded="n"><![CDATA[dunes://service.dunes.ch/CustomSDKObject?id='bd23869b-b58a-43ca-b0b2-b08857c76199'&dunesName='vCACCAFE:VCACHost']]></value>
  </attrib>
  <attrib name="approvalPolicy" type="vCACCAFE:ApprovalPolicy" read-only="false">
    <value encoded="n"><![CDATA[dunes://service.dunes.ch/CustomSDKObject?id='bd23869b-b58a-43ca-b0b2-b08857c76199/3e0c90e2-723e-4915-b474-f21068ca21cd'&dunesName='vCACCAFE:ApprovalPolicy']]></value>
  </attrib>
  <workflow-item name="item0" type="end" end-mode="0">
    <position y="45.40909090909091" x="384.5"/>
  </workflow-item>
  <workflow-item name="item1" out-name="item0" type="task">
    <display-name><![CDATA[Scriptable task]]></display-name>
    <script encoded="false"><![CDATA[var businessGroup = "test group 87"
var client = cafeHost.createCatalogClient().getCatalogEntitlementService();
var entitled = vCACCAFEEntitiesFinder.getEntitlements(cafeHost)
System.log(" "); //space in log for when run against all entitlements
System.log("Approval Policy ID = "+approvalPolicy.getId());

for each (var entitle in entitled){
	if (entitle.name == businessGroup){ //comment out to run against all
		System.log("Entitlement = "+entitle.name)
		var services = entitle.entitledServices
		for each (var service in services){
			var a = service.getServiceRef();
			var serviceLabel = a.getLabel();
			System.log("Entitled Services = "+serviceLabel);
			if (serviceLabel == "Servers"){
				System.log("Setting Approval Policy on the "+serviceLabel+" Service, for "+entitle.name);
				service.setApprovalPolicyId(approvalPolicy.getId());  //set to null to remove Approval Policy
				client.update(entitle);
			}
		}
	}  //comment out to run against all
}]]></script>
    <in-binding>
      <bind name="cafeHost" type="vCACCAFE:VCACHost" export-name="cafeHost"/>
      <bind name="approvalPolicy" type="vCACCAFE:ApprovalPolicy" export-name="approvalPolicy"/>
    </in-binding>
    <out-binding/>
    <position y="55.40909090909091" x="204.5"/>
  </workflow-item>
  <presentation/>
</workflow>