<?xml version='1.0' encoding='UTF-8'?>
<workflow xmlns="http://vmware.com/vco/workflow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://vmware.com/vco/workflow http://vmware.com/vco/workflow/Workflow-v4.xsd" root-name="item3" object-name="workflow:name=generic" id="a437e8ea-f33f-4eca-b1fd-1da46c738a57" version="0.0.5" api-version="6.0.0" allowed-operations="evf" restartMode="1" resumeFromFailedMode="0">
  <display-name><![CDATA[Check Server Status (etcd)]]></display-name>
  <position y="45.90909090909091" x="285.0"/>
  <input>
    <param name="serverName" type="string"/>
  </input>
  <attrib name="deployContentLength" type="Number" read-only="false">
    <description><![CDATA[Response content length]]></description>
  </attrib>
  <attrib name="deployHeaders" type="Properties" read-only="false">
    <description><![CDATA[Response headers]]></description>
  </attrib>
  <attrib name="deployContentAsString" type="String" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
    <description><![CDATA[Response content as string]]></description>
  </attrib>
  <attrib name="statusCode" type="Number" read-only="false">
    <description><![CDATA[Response status code]]></description>
  </attrib>
  <attrib name="currentStatus" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
    <description><![CDATA[Current status of job ]]></description>
  </attrib>
  <attrib name="sleepTime" type="number" read-only="false">
    <value encoded="n"><![CDATA[60.0]]></value>
    <description><![CDATA[Time to sleep in seconds]]></description>
  </attrib>
  <attrib name="counter" type="number" read-only="false">
    <value encoded="n"><![CDATA[0.0]]></value>
    <description><![CDATA[counter to increment]]></description>
  </attrib>
  <attrib name="errorCode" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
    <description><![CDATA[ERROR!]]></description>
  </attrib>
  <attrib name="etcd_status_url" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
  </attrib>
  <workflow-note x="738.0" y="43.45454545454544" w="410.0" h="134.0" color="a1d7d7ff">
    <description><![CDATA[Check status of Job]]></description>
  </workflow-note>
  <workflow-item name="item4" out-name="item5" type="task">
    <display-name><![CDATA[Get Status]]></display-name>
    <script encoded="false"><![CDATA[var obj = JSON.parse(statusContentAsString);

var currentStatus = obj.node.value;
]]></script>
    <in-binding>
      <bind name="statusContentAsString" type="String" export-name="deployContentAsString"/>
    </in-binding>
    <out-binding>
      <bind name="currentStatus" type="string" export-name="currentStatus"/>
    </out-binding>
    <position y="55.40909090909091" x="864.5"/>
  </workflow-item>
  <workflow-item name="item5" out-name="item6" type="custom-condition" alt-out-name="item10">
    <display-name><![CDATA[Running?]]></display-name>
    <script encoded="false"><![CDATA[if(currentStatus != 'active') {
	return true;
} else { 
	return false;
}]]></script>
    <in-binding>
      <bind name="currentStatus" type="string" export-name="currentStatus"/>
    </in-binding>
    <position y="45.40909090909091" x="1004.5"/>
  </workflow-item>
  <workflow-item name="item0" prototype-id="sleep" out-name="item1" content-mode="x" type="task">
    <display-name><![CDATA[Sleep]]></display-name>
    <script encoded="false"><![CDATA[//Auto-generated script
if ( sleepTime != null )  {
	System.sleep(sleepTime*1000);
}
else  {
	throw "'sleepTime' is NULL";
}
]]></script>
    <in-binding>
      <bind name="sleepTime" type="number" export-name="sleepTime">
        <description><![CDATA[Time to sleep in seconds]]></description>
      </bind>
    </in-binding>
    <out-binding/>
    <description><![CDATA[Sleep a given number of seconds]]></description>
    <position y="119.04545454545453" x="724.5"/>
  </workflow-item>
  <workflow-item name="item6" prototype-id="increase-counter" out-name="item7" content-mode="x" type="task">
    <display-name><![CDATA[Increase counter]]></display-name>
    <script encoded="false"><![CDATA[//Auto-generated script
counter = counter+1;]]></script>
    <in-binding>
      <bind name="counter" type="number" export-name="counter">
        <description><![CDATA[counter to increment]]></description>
      </bind>
    </in-binding>
    <out-binding>
      <bind name="counter" type="number" export-name="counter">
        <description><![CDATA[counter incremented]]></description>
      </bind>
    </out-binding>
    <description><![CDATA[Increment a counter by one]]></description>
    <position y="119.04545454545453" x="1004.5"/>
  </workflow-item>
  <workflow-item name="item7" out-name="item0" type="custom-condition" alt-out-name="item9">
    <display-name><![CDATA[Threshold Met?]]></display-name>
    <script encoded="false"><![CDATA[if(counter < 120) {
	return true;
} else {
	return false;
}]]></script>
    <in-binding>
      <bind name="counter" type="number" export-name="counter"/>
    </in-binding>
    <position y="109.04545454545453" x="864.5"/>
  </workflow-item>
  <workflow-item name="item8" throw-bind-name="errorCode" type="end" end-mode="1">
    <position y="236.3181818181818" x="904.5"/>
  </workflow-item>
  <workflow-item name="item9" out-name="item8" type="task">
    <display-name><![CDATA[Form Error Code]]></display-name>
    <script encoded="false"><![CDATA[errorCode = 'The ansible provisioning of ' + serverName + ' has taken longer then expected.  This provisioning request will be failed.  The UCP team has been notified of this failure.'
]]></script>
    <in-binding>
      <bind name="serverName" type="string" export-name="serverName"/>
    </in-binding>
    <out-binding>
      <bind name="errorCode" type="string" export-name="errorCode"/>
    </out-binding>
    <position y="191.77272727272725" x="864.5"/>
  </workflow-item>
  <workflow-item name="item10" out-name="item11" type="custom-condition" alt-out-name="item12">
    <display-name><![CDATA[Success?]]></display-name>
    <script encoded="false"><![CDATA[if(currentStatus == "active") {
	return true;
} else {
	return false;
}]]></script>
    <in-binding>
      <bind name="currentStatus" type="string" export-name="currentStatus"/>
    </in-binding>
    <position y="45.40909090909091" x="1144.5"/>
  </workflow-item>
  <workflow-item name="item12" out-name="item13" type="task">
    <display-name><![CDATA[Form Failure Code]]></display-name>
    <script encoded="false"><![CDATA[errorCode = 'The provisioning of ' + serverName + ' has taken longer then expected.  This provisioning request will be failed.  The UCP team has been notified of this failure.'
]]></script>
    <in-binding>
      <bind name="serverName" type="string" export-name="serverName"/>
    </in-binding>
    <out-binding>
      <bind name="errorCode" type="string" export-name="errorCode"/>
    </out-binding>
    <position y="119.04545454545453" x="1144.5"/>
  </workflow-item>
  <workflow-item name="item13" throw-bind-name="errorCode" type="end" end-mode="1">
    <position y="163.59090909090907" x="1184.5"/>
  </workflow-item>
  <workflow-item name="item11" type="end" end-mode="0">
    <position y="45.40909090909091" x="1324.5"/>
  </workflow-item>
  <workflow-item name="item1" out-name="item4" type="link" linked-workflow-id="79e07ff4-9696-4bba-9c2b-9845f5698131">
    <display-name><![CDATA[etcd - Get Key]]></display-name>
    <in-binding>
      <bind name="key" type="string" export-name="etcd_status_url">
        <description><![CDATA[etcd key to update]]></description>
      </bind>
    </in-binding>
    <out-binding>
      <bind name="statusCode" type="Number" export-name="statusCode">
        <description><![CDATA[Response status code]]></description>
      </bind>
      <bind name="contentLength" type="Number" export-name="deployContentLength">
        <description><![CDATA[Response content length]]></description>
      </bind>
      <bind name="headers" type="Properties" export-name="deployHeaders">
        <description><![CDATA[Response headers]]></description>
      </bind>
      <bind name="contentAsString" type="String" export-name="deployContentAsString">
        <description><![CDATA[Response content as string]]></description>
      </bind>
    </out-binding>
    <description><![CDATA[Autogenerated workflow.]]></description>
    <position y="55.40909090909091" x="724.5"/>
  </workflow-item>
  <workflow-item name="item3" out-name="item1" type="task">
    <display-name><![CDATA[Generate status URL]]></display-name>
    <script encoded="false"><![CDATA[//We take all of the variables and work above and generate our etcd keys and values arrays.
var baseURL = 'unifiedcompute/servers/';  //the base URL for all UCP records in etcd
var serverURL = baseURL + serverName + '/';
var etcd_status_url = serverURL + 'state'

]]></script>
    <in-binding>
      <bind name="serverName" type="string" export-name="serverName">
        <description><![CDATA[Server name to apply the post deploy configuration]]></description>
      </bind>
    </in-binding>
    <out-binding>
      <bind name="etcd_status_url" type="string" export-name="etcd_status_url"/>
    </out-binding>
    <position y="55.40909090909091" x="424.5"/>
  </workflow-item>
  <presentation>
    <p-param name="serverName">
      <desc><![CDATA[serverName]]></desc>
    </p-param>
  </presentation>
</workflow>