<?xml version='1.0' encoding='UTF-8'?>
<workflow xmlns="http://vmware.com/vco/workflow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://vmware.com/vco/workflow http://vmware.com/vco/workflow/Workflow-v4.xsd" root-name="item17" object-name="workflow:name=generic" id="61a812b4-625b-4364-ba6d-1f4dc0ca1e2d" version="0.0.3" api-version="6.0.0" allowed-operations="evf" restartMode="1" resumeFromFailedMode="0">
  <display-name><![CDATA[DBAS Deploy and Check Status]]></display-name>
  <position y="0.0" x="125.0"/>
  <input>
    <param name="serverName" type="string">
      <description><![CDATA[Server name to apply the post deploy configuration]]></description>
    </param>
    <param name="dbas" type="string"/>
    <param name="dbname" type="string"/>
    <param name="dbadmin_username" type="string"/>
    <param name="environment" type="string"/>
    <param name="dbms_type" type="string"/>
    <param name="businessGroup" type="string"/>
    <param name="serverOwner" type="string"/>
    <param name="contactPDL" type="string"/>
  </input>
  <attrib name="deployStatusCode" type="Number" read-only="false">
    <description><![CDATA[Response status code]]></description>
  </attrib>
  <attrib name="deployContentLength" type="Number" read-only="false">
    <description><![CDATA[Response content length]]></description>
  </attrib>
  <attrib name="deployHeaders" type="Properties" read-only="false">
    <description><![CDATA[Response headers]]></description>
  </attrib>
  <attrib name="deployContentAsString" type="String" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
    <description><![CDATA[Response content as string]]></description>
  </attrib>
  <attrib name="jobStatusID" type="number" read-only="false">
    <value encoded="n"><![CDATA[__NULL__]]></value>
    <description><![CDATA[The Job ID to check for a status]]></description>
  </attrib>
  <attrib name="statusCode" type="Number" read-only="false">
    <description><![CDATA[Response status code]]></description>
  </attrib>
  <attrib name="statusContentLength" type="Number" read-only="false">
    <description><![CDATA[Response content length]]></description>
  </attrib>
  <attrib name="statusHeaders" type="Properties" read-only="false">
    <description><![CDATA[Response headers]]></description>
  </attrib>
  <attrib name="statusContentAsString" type="String" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
    <description><![CDATA[Response content as string]]></description>
  </attrib>
  <attrib name="currentStatus" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
    <description><![CDATA[Current status of job ]]></description>
  </attrib>
  <attrib name="sleepTime" type="number" read-only="false">
    <value encoded="n"><![CDATA[60.0]]></value>
    <description><![CDATA[Time to sleep in seconds]]></description>
  </attrib>
  <attrib name="counter" type="number" read-only="false">
    <value encoded="n"><![CDATA[0.0]]></value>
    <description><![CDATA[counter to increment]]></description>
  </attrib>
  <attrib name="errorCode" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
    <description><![CDATA[ERROR!]]></description>
  </attrib>
  <attrib name="sleepTime10" type="number" read-only="false">
    <value encoded="n"><![CDATA[10.0]]></value>
    <description><![CDATA[Time to sleep in seconds]]></description>
  </attrib>
  <workflow-note x="560.0" y="54.04545454545453" w="280.0" h="174.0" color="a1d7d7ff">
    <description><![CDATA[Check status of Job]]></description>
  </workflow-note>
  <workflow-note x="80.0" y="45.45454545454544" w="400.0" h="67.0">
    <description><![CDATA[Run Job in Ansible Tower]]></description>
  </workflow-note>
  <workflow-item name="item17" out-name="item18" type="link" linked-workflow-id="6d7a5d04-b0ec-4136-8d54-2db3f62720a9">
    <display-name><![CDATA[Provision DBAS]]></display-name>
    <in-binding>
      <bind name="serverName" type="string" export-name="serverName">
        <description><![CDATA[Server name to apply the post deploy configuration]]></description>
      </bind>
      <bind name="dbas" type="string" export-name="dbas">
        <description><![CDATA[Flag for database as a service selection logic]]></description>
      </bind>
      <bind name="dbname" type="string" export-name="dbname"/>
      <bind name="dbadmin_username" type="string" export-name="dbadmin_username"/>
      <bind name="environment" type="string" export-name="environment"/>
      <bind name="dbms_type" type="string" export-name="dbms_type"/>
      <bind name="businessGroup" type="string" export-name="businessGroup"/>
      <bind name="serverOwner" type="string" export-name="serverOwner"/>
      <bind name="contactPDL" type="string" export-name="contactPDL"/>
    </in-binding>
    <out-binding>
      <bind name="statusCode" type="Number" export-name="deployStatusCode">
        <description><![CDATA[Response status code]]></description>
      </bind>
      <bind name="contentLength" type="Number" export-name="deployContentLength">
        <description><![CDATA[Response content length]]></description>
      </bind>
      <bind name="headers" type="Properties" export-name="deployHeaders">
        <description><![CDATA[Response headers]]></description>
      </bind>
      <bind name="contentAsString" type="String" export-name="deployContentAsString">
        <description><![CDATA[Response content as string]]></description>
      </bind>
    </out-binding>
    <description><![CDATA[Autogenerated workflow.]]></description>
    <position y="64.5" x="84.5"/>
  </workflow-item>
  <workflow-item name="item18" out-name="item19" type="task">
    <display-name><![CDATA[Get Job ID]]></display-name>
    <script encoded="false"><![CDATA[var obj = JSON.parse(deployContentAsString);

var jobStatusID = obj.job;
//jobStatusID.toString();

System.log("Checking the status of Job: "+jobStatusID);]]></script>
    <in-binding>
      <bind name="deployContentAsString" type="String" export-name="deployContentAsString"/>
    </in-binding>
    <out-binding>
      <bind name="jobStatusID" type="number" export-name="jobStatusID"/>
    </out-binding>
    <position y="64.5" x="224.5"/>
  </workflow-item>
  <workflow-item name="item19" prototype-id="sleep" out-name="item20" content-mode="x" type="task">
    <display-name><![CDATA[Sleep10]]></display-name>
    <script encoded="false"><![CDATA[//Auto-generated script
if ( sleepTime != null )  {
	System.sleep(sleepTime*1000);
}
else  {
	throw "'sleepTime' is NULL";
}
]]></script>
    <in-binding>
      <bind name="sleepTime" type="number" export-name="sleepTime10">
        <description><![CDATA[Time to sleep in seconds]]></description>
      </bind>
    </in-binding>
    <out-binding/>
    <description><![CDATA[Sleep a given number of seconds]]></description>
    <position y="64.5" x="364.5"/>
  </workflow-item>
  <workflow-item name="item20" out-name="item21" type="link" linked-workflow-id="ce28b43f-0b9c-4eb6-9ffd-d66193b18f25">
    <display-name><![CDATA[Check Job Status]]></display-name>
    <in-binding>
      <bind name="jobID" type="number" export-name="jobStatusID">
        <description><![CDATA[jobID]]></description>
      </bind>
    </in-binding>
    <out-binding>
      <bind name="statusCode" type="Number" export-name="statusCode">
        <description><![CDATA[Response status code]]></description>
      </bind>
      <bind name="contentLength" type="Number" export-name="statusContentLength">
        <description><![CDATA[Response content length]]></description>
      </bind>
      <bind name="headers" type="Properties" export-name="statusHeaders">
        <description><![CDATA[Response headers]]></description>
      </bind>
      <bind name="contentAsString" type="String" export-name="statusContentAsString">
        <description><![CDATA[Response content as string]]></description>
      </bind>
    </out-binding>
    <description><![CDATA[Autogenerated workflow.]]></description>
    <position y="64.5" x="724.5"/>
  </workflow-item>
  <workflow-item name="item21" out-name="item22" type="task">
    <display-name><![CDATA[Get Status]]></display-name>
    <script encoded="false"><![CDATA[var obj = JSON.parse(statusContentAsString);

var currentStatus = obj.status;
]]></script>
    <in-binding>
      <bind name="statusContentAsString" type="String" export-name="statusContentAsString"/>
    </in-binding>
    <out-binding>
      <bind name="currentStatus" type="string" export-name="currentStatus"/>
    </out-binding>
    <position y="128.13636363636363" x="724.5"/>
  </workflow-item>
  <workflow-item name="item22" out-name="item27" type="custom-condition" alt-out-name="item24">
    <display-name><![CDATA[Running?]]></display-name>
    <script encoded="false"><![CDATA[if(currentStatus == "running" || currentStatus == "pending" || currentStatus == "waiting") {
	return true;
} else { 
	return false;
}]]></script>
    <in-binding>
      <bind name="currentStatus" type="string" export-name="currentStatus"/>
    </in-binding>
    <position y="181.77272727272725" x="724.5"/>
  </workflow-item>
  <workflow-item name="item23" type="end" end-mode="0">
    <position y="181.77272727272725" x="1044.5"/>
  </workflow-item>
  <workflow-item name="item24" out-name="item23" type="custom-condition" alt-out-name="item26">
    <display-name><![CDATA[Success?]]></display-name>
    <script encoded="false"><![CDATA[if(currentStatus == "successful") {
	return true;
} else {
	return false;
}]]></script>
    <in-binding>
      <bind name="currentStatus" type="string" export-name="currentStatus"/>
    </in-binding>
    <position y="181.77272727272725" x="864.5"/>
  </workflow-item>
  <workflow-item name="item25" throw-bind-name="errorCode" type="end" end-mode="1">
    <position y="290.8636363636363" x="904.5"/>
  </workflow-item>
  <workflow-item name="item26" out-name="item25" type="task">
    <display-name><![CDATA[Form Failure Code]]></display-name>
    <script encoded="false"><![CDATA[errorCode = "Ansible has failed to apply DBAS configuration to "+serverName+" through Job ID "+jobStatusID+".";]]></script>
    <in-binding>
      <bind name="serverName" type="string" export-name="serverName"/>
      <bind name="jobStatusID" type="number" export-name="jobStatusID"/>
      <bind name="currentStatus" type="string" export-name="currentStatus"/>
    </in-binding>
    <out-binding>
      <bind name="errorCode" type="string" export-name="errorCode"/>
    </out-binding>
    <position y="255.40909090909088" x="865.0"/>
  </workflow-item>
  <workflow-item name="item27" prototype-id="increase-counter" out-name="item28" content-mode="x" type="task">
    <display-name><![CDATA[Increase counter]]></display-name>
    <script encoded="false"><![CDATA[//Auto-generated script
counter = counter+1;]]></script>
    <in-binding>
      <bind name="counter" type="number" export-name="counter">
        <description><![CDATA[counter to increment]]></description>
      </bind>
    </in-binding>
    <out-binding>
      <bind name="counter" type="number" export-name="counter">
        <description><![CDATA[counter incremented]]></description>
      </bind>
    </out-binding>
    <description><![CDATA[Increment a counter by one]]></description>
    <position y="191.77272727272725" x="584.5"/>
  </workflow-item>
  <workflow-item name="item28" out-name="item31" type="custom-condition" alt-out-name="item30">
    <display-name><![CDATA[Threshold Met?]]></display-name>
    <script encoded="false"><![CDATA[if(counter < 120) {
	return true;
} else {
	return false;
}]]></script>
    <in-binding>
      <bind name="counter" type="number" export-name="counter"/>
    </in-binding>
    <position y="118.13636363636363" x="584.5"/>
  </workflow-item>
  <workflow-item name="item29" throw-bind-name="errorCode" type="end" end-mode="1">
    <position y="181.77272727272725" x="484.5"/>
  </workflow-item>
  <workflow-item name="item30" out-name="item29" type="task">
    <display-name><![CDATA[Form Error Code]]></display-name>
    <script encoded="false"><![CDATA[errorCode = "Ansible has failed to apply configuration to "+serverName+" through Job ID "+jobStatusID+" in a timely manner. It's current status is: "+currentStatus+".";]]></script>
    <in-binding>
      <bind name="serverName" type="string" export-name="serverName"/>
      <bind name="jobStatusID" type="number" export-name="jobStatusID"/>
      <bind name="currentStatus" type="string" export-name="currentStatus"/>
    </in-binding>
    <out-binding>
      <bind name="errorCode" type="string" export-name="errorCode"/>
    </out-binding>
    <position y="128.13636363636363" x="445.0"/>
  </workflow-item>
  <workflow-item name="item31" prototype-id="sleep" out-name="item20" content-mode="x" type="task">
    <display-name><![CDATA[Sleep]]></display-name>
    <script encoded="false"><![CDATA[//Auto-generated script
if ( sleepTime != null )  {
	System.sleep(sleepTime*1000);
}
else  {
	throw "'sleepTime' is NULL";
}
]]></script>
    <in-binding>
      <bind name="sleepTime" type="number" export-name="sleepTime">
        <description><![CDATA[Time to sleep in seconds]]></description>
      </bind>
    </in-binding>
    <out-binding/>
    <description><![CDATA[Sleep a given number of seconds]]></description>
    <position y="64.5" x="584.5"/>
  </workflow-item>
  <presentation>
    <p-param name="serverName">
      <desc><![CDATA[Server name to apply the post deploy configuration]]></desc>
    </p-param>
    <p-param name="dbas">
      <desc><![CDATA[dbas]]></desc>
    </p-param>
    <p-param name="dbname">
      <desc><![CDATA[dbname]]></desc>
    </p-param>
    <p-param name="dbadmin_username">
      <desc><![CDATA[dbadmin_username]]></desc>
    </p-param>
    <p-param name="environment">
      <desc><![CDATA[environment]]></desc>
    </p-param>
    <p-param name="dbms_type">
      <desc><![CDATA[dbms_type]]></desc>
    </p-param>
    <p-param name="businessGroup">
      <desc><![CDATA[businessGroup]]></desc>
    </p-param>
    <p-param name="serverOwner">
      <desc><![CDATA[serverOwner]]></desc>
    </p-param>
    <p-param name="contactPDL">
      <desc><![CDATA[contactPDL]]></desc>
    </p-param>
  </presentation>
</workflow>