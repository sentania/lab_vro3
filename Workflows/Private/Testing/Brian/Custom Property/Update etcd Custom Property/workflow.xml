<?xml version='1.0' encoding='UTF-8'?>
<workflow xmlns="http://vmware.com/vco/workflow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://vmware.com/vco/workflow http://vmware.com/vco/workflow/Workflow-v4.xsd" root-name="item1" object-name="workflow:name=generic" id="cee0b0a3-d5d8-4789-ad42-d93a77b29176" version="0.0.1" api-version="6.0.0" allowed-operations="evf" restartMode="1" resumeFromFailedMode="0">
  <display-name><![CDATA[Update etcd Custom Property]]></display-name>
  <description><![CDATA[The workflow will get all the vcac:virtualmachines from the vRA environment.  It will then determine if the virtual machine is managed by vRA.  If it is, the workflow will get all the properties of the vm, get the necessary properties to populate etcd, and then update etcd.]]></description>
  <position y="50.0" x="100.0"/>
  <output>
    <param name="var" type="Array/CompositeType(statusCode:Number,contentLength:Number,headers:Properties,contentAsString:String)"/>
  </output>
  <attrib name="etcd_keys" type="Array/string" read-only="false">
    <value encoded="n"><![CDATA[__NULL__]]></value>
  </attrib>
  <attrib name="etcd_values" type="Array/string" read-only="false">
    <value encoded="n"><![CDATA[__NULL__]]></value>
  </attrib>
  <workflow-item name="item0" type="end" end-mode="0">
    <position y="45.40909090909091" x="664.5"/>
  </workflow-item>
  <workflow-item name="item1" out-name="item2" type="task">
    <display-name><![CDATA[Scriptable task]]></display-name>
    <script encoded="false"><![CDATA[var host = Server.findAllForType("vCAC:VCACHost")[0]; //find vcac host
var vms = Server.findAllForType("vCAC:VirtualMachine");//find all vcac virtual machines
var module = System.getModule("com.vmware.library.vcac")//pulling getmodule out of the loop for performance
var baseURL = 'unifiedcompute/servers/';  //the base URL for all UCP records in etcd
var bgPdl = "nm.ucp.businessGroupPDL";
//var cherwellValue = "Batch Transformation";

var etcd_keys = [];
var etcd_values = [];
				

//Sorting vms
vms.sort();
		
for each (vm in vms) {
	if (vm.isManaged == true) {
		
		//Documenting server name and is managed
		//System.log("vm name = "+vm.virtualMachineName);
		//System.log("VM IS managed = "+vm.isManaged);
		
		//Getting Properties of vm
		//var props = module.getPropertiesFromVirtualMachine(host, vm);
		var props = module.getPropertyFromVirtualMachine(host,vm,bgPdl);
		
		//Setting up etcd config
		var VMName = vm.virtualMachineName;
		var serverURL = baseURL + VMName + '/';

		
		//Adding Business Group
			//var groupPDL = props.get("nm.ucp.cherwellName");
			System.log("vm name = "+vm.virtualMachineName+"/"+props);
			System.log(props);
			etcd_keys.push(serverURL + 'contactPDL');
			etcd_values.push(encodeURI(props));


	}	
}
System.log("etcd keys "+etcd_keys);
System.log("etcd values "+etcd_keys);


]]></script>
    <in-binding/>
    <out-binding>
      <bind name="etcd_keys" type="Array/string" export-name="etcd_keys"/>
      <bind name="etcd_values" type="Array/string" export-name="etcd_values"/>
    </out-binding>
    <position y="55.40909090909091" x="204.5"/>
  </workflow-item>
  <workflow-item name="item2" out-name="item0" type="foreach">
    <display-name><![CDATA[Foreach (etcd - Add Key)]]></display-name>
    <in-binding>
      <bind name="key" type="Array/string" export-name="*etcd_keys">
        <description><![CDATA[etcd key to update]]></description>
      </bind>
      <bind name="value" type="Array/string" export-name="*etcd_values">
        <description><![CDATA[value of the key]]></description>
      </bind>
    </in-binding>
    <out-binding>
      <bind name="statusCode" type="Array/Number" export-name="*var.statusCode"/>
      <bind name="contentLength" type="Array/Number" export-name="*var.contentLength"/>
      <bind name="headers" type="Array/Properties" export-name="*var.headers"/>
      <bind name="contentAsString" type="Array/String" export-name="*var.contentAsString"/>
    </out-binding>
    <reference type="Workflow" id="1fa52ce3-f6c0-43f8-a28f-6790c2e93f13"/>
    <description><![CDATA[Autogenerated workflow.]]></description>
    <position y="55.90909090909091" x="345.0"/>
  </workflow-item>
  <presentation/>
</workflow>