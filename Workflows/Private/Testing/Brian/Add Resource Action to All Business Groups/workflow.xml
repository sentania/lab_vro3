<?xml version='1.0' encoding='UTF-8'?>
<workflow xmlns="http://vmware.com/vco/workflow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://vmware.com/vco/workflow http://vmware.com/vco/workflow/Workflow-v4.xsd" root-name="item1" object-name="workflow:name=generic" id="c732ceff-92a0-4538-a77a-da31892ed058" version="0.0.1" api-version="6.0.0" allowed-operations="vfe" restartMode="1" resumeFromFailedMode="0">
  <display-name><![CDATA[Add Resource Action to All Business Groups]]></display-name>
  <position y="50.0" x="100.0"/>
  <attrib name="actionToAdd" type="vCACCAFE:CatalogResourceAction" read-only="false">
    <value encoded="n"><![CDATA[dunes://service.dunes.ch/CustomSDKObject?id='bd23869b-b58a-43ca-b0b2-b08857c76199/06e057b7-d601-416d-a55e-0173d265554a'&dunesName='vCACCAFE:CatalogResourceAction']]></value>
  </attrib>
  <workflow-item name="item0" type="end" end-mode="0">
    <position y="45.40909090909091" x="384.5"/>
  </workflow-item>
  <workflow-item name="item1" out-name="item0" type="task">
    <display-name><![CDATA[Scriptable task]]></display-name>
    <script encoded="false"><![CDATA[var host = Server.findAllForType("vCACCAFE:VCACHost")[0];
var ents = vCACCAFEEntitiesFinder.getEntitlements(host)
var client = host.createCatalogClient().getCatalogEntitlementService();
var entitledAction;

for each (a in ents){  //getting all entitlements and then adds the action from input actionToAdd to each
	//if (a.name == "test group 87" || a.name == "UCP Admin"){  //uncomment along with line 32 if you only want to run for a specific business group
		System.log("Checking "+a.name);
		var entitledResourceOperations = a.getEntitledResourceOperations();
		//System.getModule("com.vmware.library.vcaccafe.util").checkHosts(a, actionToAdd, "entitlement", "resource action");
			
		//Check if the resource operation already exists in the entitlement
		var alreadyExists = false;
		for(var j = 0 ; j < entitledResourceOperations.length ; j++ ) {
			if(entitledResourceOperations[j].getResourceOperationRef().getId() == actionToAdd.getId()) {
				System.warn("Resource action " + actionToAdd.getName() + " is already entitled. The action will be skipped for "+a.name);
				alreadyExists = true;
			}
		}	
	if(!alreadyExists) {  //if action does not exists within the entitlement it will add it
		entitledAction = new vCACCAFEEntitledResourceOperation();
		var resourceOperationReference = new vCACCAFELabelledReference();
		resourceOperationReference.setId(actionToAdd.getId());
		resourceOperationReference.setLabel(actionToAdd.getName());
		entitledAction.setResourceOperationRef(resourceOperationReference);

		System.getModule("com.vmware.library.vcaccafe.util").addElementToList(a, "getEntitledResourceOperations", entitledAction);
		client.update(a);
		System.log("Adding "+actionToAdd.getName()+" to the entitlement " + a.getName());
	}

	}
//} //uncomment along with line 6 if you only want to run for a specific business group
]]></script>
    <in-binding>
      <bind name="actionToAdd" type="vCACCAFE:CatalogResourceAction" export-name="actionToAdd"/>
    </in-binding>
    <out-binding/>
    <position y="55.40909090909091" x="204.5"/>
  </workflow-item>
  <presentation/>
</workflow>