<?xml version='1.0' encoding='UTF-8'?>
<workflow xmlns="http://vmware.com/vco/workflow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://vmware.com/vco/workflow http://vmware.com/vco/workflow/Workflow-v4.xsd" root-name="item4" object-name="workflow:name=generic" id="a2d1ac51-ac9b-4303-a2b5-2ee391a58e71" version="1.0.0" api-version="6.0.0" allowed-operations="evf" restartMode="1" resumeFromFailedMode="0">
  <display-name><![CDATA[Create a Computer object in vRA-specified OU (BuildingMachine)]]></display-name>
  <description><![CDATA[Looks for a vRA Custom Property called ActiveDirectory.OU which containes the Distinguished Name of an OU in which to create the Computer object.  
If not found, then it uses a default OU, whose Distinguished Name is stored in a vRO Configuration Element.

Requires the Computer name (hostname) as input in case it is being changed by another workflow, but hasn't taken effect yet.
Should be called from the BuildingMachine provisioning state.]]></description>
  <position y="50.0" x="100.0"/>
  <input>
    <param name="customProperties" type="Properties">
      <description><![CDATA[vRA Custom Properties from the Event Subscription payload]]></description>
    </param>
    <param name="computerName" type="string">
      <description><![CDATA[Name for the new computer]]></description>
    </param>
  </input>
  <output>
    <param name="newComputer" type="AD:ComputerAD">
      <description><![CDATA[The new Computer object in AD]]></description>
    </param>
  </output>
  <attrib name="defaultOuDn" type="string" read-only="true" conf-id="000223b2-3433-4bfc-8c1f-c4c4dc1f8bf7" conf-key="defaultComputerOuDn">
    <value encoded="n"><![CDATA[]]></value>
    <description><![CDATA[Distinguished Name of the OU where new VMs are placed by default.  Overridden by the ActiveDirectory.OU custom property.]]></description>
  </attrib>
  <attrib name="customPropForOuDn" type="string" read-only="true">
    <value encoded="n"><![CDATA[ActiveDirectory.OU]]></value>
    <description><![CDATA[The vRA custom property to look for]]></description>
  </attrib>
  <attrib name="ouDnToUse" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
    <description><![CDATA[OU DN, either from a custom prop if present, or the default]]></description>
  </attrib>
  <workflow-item name="item0" type="end" end-mode="0">
    <position y="45.40909090909091" x="944.5"/>
  </workflow-item>
  <workflow-item name="item1" out-name="item2" type="task">
    <display-name><![CDATA[Get OU DN]]></display-name>
    <script encoded="false"><![CDATA[//Get the custom prop from vRA, if present
var ouDnFromVra = customProperties.get(customPropForOuDn);

if (ouDnFromVra) {
	System.log("Using OU Distinguished Name specified in vRA Custom Property '" + customPropForOuDn + "'");
	ouDnToUse = ouDnFromVra;
} else { //Use default OU
	System.log("vRA Custom Property '" + customPropForOuDn + "' wasn't found. Using default OU instead.");
	ouDnToUse = defaultOuDn;
}]]></script>
    <in-binding>
      <bind name="customProperties" type="Properties" export-name="customProperties">
        <description><![CDATA[vRA Custom Properties from the Event Subscription payload]]></description>
      </bind>
      <bind name="defaultOuDn" type="string" export-name="defaultOuDn">
        <description><![CDATA[Distinguished Name of the OU where new VMs are placed by default.  Overridden by the ActiveDirectory.OU custom property.]]></description>
      </bind>
      <bind name="customPropForOuDn" type="string" export-name="customPropForOuDn">
        <description><![CDATA[The vRA custom property to look for]]></description>
      </bind>
    </in-binding>
    <out-binding>
      <bind name="ouDnToUse" type="string" export-name="ouDnToUse">
        <description><![CDATA[OU DN, either from a custom prop if present, or the default]]></description>
      </bind>
    </out-binding>
    <description><![CDATA[If ]]></description>
    <position y="55.40909090909091" x="484.5"/>
  </workflow-item>
  <workflow-item name="item2" out-name="item5" type="link" linked-workflow-id="7c2d940e-1560-4379-be34-5eecd63a6859">
    <display-name><![CDATA[Create a Computer in an AD OU (by DN)]]></display-name>
    <in-binding>
      <bind name="computerName" type="string" export-name="computerName">
        <description><![CDATA[Name for the new computer]]></description>
      </bind>
      <bind name="ouDistinguishedName" type="string" export-name="ouDnToUse">
        <description><![CDATA[The Distinguished Name (path) of the OU]]></description>
      </bind>
    </in-binding>
    <out-binding>
      <bind name="newComputer" type="AD:ComputerAD" export-name="newComputer">
        <description><![CDATA[The new Computer object in AD]]></description>
      </bind>
    </out-binding>
    <description><![CDATA[Creates a new Computer object in the specified OU.

Prerequisite: vRO's AD plug-in must be configured with a Default server (AD:AdHost) by running the 'Configure Active Directory plug-in options' workflow.]]></description>
    <position y="55.40909090909091" x="624.5"/>
  </workflow-item>
  <workflow-item name="item3" out-name="item1" type="task">
    <display-name><![CDATA[Validate Inputs]]></display-name>
    <script encoded="false"><![CDATA[if (!customProperties) { throw "Required input, customProperties, was missing."; }

if (!computerName) { throw "Required input, computerName, was missing."; }]]></script>
    <in-binding>
      <bind name="customProperties" type="Properties" export-name="customProperties">
        <description><![CDATA[vRA Custom Properties from the Event Subscription payload]]></description>
      </bind>
      <bind name="computerName" type="string" export-name="computerName">
        <description><![CDATA[Name for the new computer]]></description>
      </bind>
    </in-binding>
    <out-binding/>
    <position y="55.40909090909091" x="344.5"/>
  </workflow-item>
  <workflow-item name="item4" prototype-id="system-log" out-name="item3" type="task" interaction="l">
    <display-name><![CDATA[Begin Workflow]]></display-name>
    <script encoded="false"><![CDATA[System.log("Begin workflow: '" + workflow.currentWorkflow.name + "'");
]]></script>
    <in-binding/>
    <out-binding/>
    <description><![CDATA[Log the input text to the console log with level 'log']]></description>
    <position y="55.40909090909091" x="204.5"/>
  </workflow-item>
  <workflow-item name="item5" prototype-id="system-log" out-name="item0" type="task" interaction="l">
    <display-name><![CDATA[End Workflow]]></display-name>
    <script encoded="false"><![CDATA[System.log("End workflow: '" + workflow.currentWorkflow.name + "'");
]]></script>
    <in-binding/>
    <out-binding/>
    <description><![CDATA[Log the input text to the console log with level 'log']]></description>
    <position y="55.40909090909091" x="764.5"/>
  </workflow-item>
  <presentation>
    <p-param name="customProperties">
      <desc><![CDATA[vRA Custom Properties from the Event Subscription payload]]></desc>
    </p-param>
    <p-param name="computerName">
      <desc><![CDATA[Name for the new computer]]></desc>
    </p-param>
  </presentation>
</workflow>